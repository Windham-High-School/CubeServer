{% extends "base.html.jinja2" %}
{% block title %}Admin{% endblock %}

{% block header %}
    <h4>Admin Console</h4>
{% endblock %}

{% block content %}
    <div class="btn-group" role="group">
        <a href={{ url_for('admin.email') }} class="btn">Send Custom Email</a>
        {% for group, mailing_list in email_groups %}
            <a href={{ url_for('admin.email', recipients=mailing_list) }} class="btn">Email {{ group }}</a>
        {% endfor %}
        <a href={{ url_for('admin.sent_email') }} class="btn bg-info">Review Sent Mail</a>
    </div>
    <br><br>
    <div class="btn-group" role="group">
        <a href={{ url_for('admin.data_table') }} class="btn bg-info">See All Logged Data</a>
        <a href={{ url_for('admin.reference_data_table') }} class="btn bg-info">Browse Reference Data</a>
    </div>
    <br><br><br>
    <h3>Teams:</h3>
    <div>
        {{teams_table}}
    </div>
{% endblock %}

{% block body %}
{{ super() }}
    <div class="justify-content-md-center container container-fluid text-center">
        <div class="row">
            {{macros.startbox("Users", "col")}}
                <p>
                    <a href={{ url_for('admin.edit_users') }} class="btn">Edit/delete users</a>
                </p>
                <hr>
                <p>
                    Invite a new user:
                </p>
                <form method="POST" action="useradd" class="form">
                    {{ user_form.hidden_tag() }}
                    {{ wtf.form_errors(user_form, hiddens="only") }}

                    {{ wtf.form_field(user_form.level) }}
                    {{ wtf.form_field(user_form.submit) }}
                </form>
            {{macros.endbox()}}

            {{macros.startbox("Beacon", "col")}}
                <a href={{ url_for('admin.beacon_table') }} class="btn">Manage Message Queue</a>
                <hr>
                <p>
                    Schedule a message now:
                </p>
                <form method="POST" action="beaconnow" class="form">
                    {{ beacon_form.hidden_tag() }}
                    {{ wtf.form_errors(beacon_form, hiddens="only") }}

                    {{ wtf.form_field(beacon_form.instant) }}
                    {{ wtf.form_field(beacon_form.message) }}
                    {{ wtf.form_field(beacon_form.division) }}
                    {{ wtf.form_field(beacon_form.destination) }}
                    {{ wtf.form_field(beacon_form.msg_format) }}
                    {{ wtf.form_field(beacon_form.intensity) }}
                    {{ wtf.form_field(beacon_form.misfire_grace) }}
                    {{ wtf.form_field(beacon_form.submit) }}
                </form>

                <hr>

                <p>
                    Bulk upload CSV packets:
                </p>
                <form method="POST" enctype="multipart/form-data" action="{{ url_for('admin.beacon_csv') }}">
                    <input type="file" name="file" class="btn">
                    <input type="submit" value="Upload" class="btn btn-submit btn-danger">
                </form>

            {{macros.endbox()}}

        </div>
        <div class="row">
            {{macros.startbox("Global Configuration", "col")}}
                <p>
                    Note: It may take up to 30 seconds for all server threads to sync their configuration after a change.
                </p>
                <p>
                    An asterisk (*) indicates that the change will not take effect until a restart of all containers.
                </p>
                <br>
                <form method="POST" action="configchange" class="form">
                    {{ config_form.hidden_tag() }}
                    <h4>General Settings:</h4>
                    <div class="form-group">
                        {{ config_form.competition_on.label }}
                        {{ config_form.competition_on(class_="form-control") }}
                    </div>
                    {{ wtf.form_field(config_form.registration_open) }}
                    {{ wtf.form_field(config_form.notify_teams) }}
                    {{ wtf.form_field(config_form.banner_message) }}
                    {{ wtf.form_field(config_form.home_description, rows=5, cols=20) }}
                    {{ wtf.form_field(config_form.reg_confirmation, rows=5, cols=20) }}
                    {{ wtf.form_field(config_form.beacon_polling_period) }}
                    <br>
                    <h4>Email Settings:</h4>
                    {{ wtf.form_field(config_form.email_domain) }}
                    {{ wtf.form_field(config_form.smtp_server) }}
                    {{ wtf.form_field(config_form.smtp_credentials) }}
                    {{ wtf.form_field(config_form.team_email_quota) }}
                    {{ wtf.form_field(config_form.quota_reset_hour) }}
                    <br><br>
                    {{ wtf.form_field(config_form.submit) }}
                </form>
                <br>
                <a href={{ url_for('admin.game_settings') }} class="btn">More Game Rules/Settings</a>
            {{macros.endbox()}}
        </div>

        <div class="row">
            {{macros.startbox("Internal API \"Team\"s", "col")}}
                <b>Reserved team names </b> (click to generate)<b>:</b> 
                <ul>
                    {% for name, url in reserved_names %}
                        {% if url == None %}
                            <li>{{name}}</li>
                        {% else %}
                            <li><a href={{url}}>{{name}}</a></li>
                        {% endif %}
                    {% endfor %}
                </ul>

                <b>Generated Certicicates: </b>
                <ul>
                    <li>Beacon Client Certificate <a href={{url_for('admin.beacon_pem')}}>beacon.pem</a></li>
                    <li>Beacon Client Private Key <a href={{url_for('admin.beacon_key')}}>beacon.key</a></li>
                    <li>API Server Certificate <a href={{url_for('config.api_cert')}}>cert.pem</a></li>
                </ul>

                <b>Latest Internal Code Downloads: </b> <i> (Built from latest source on github (origin/main)) </i>
                <ul>
                    <li>Beacon Code <a href={{url_for('admin.package_beacon_code')}}>Packaged ZIP File</a></li>
                </ul>

            {{macros.endbox()}}
            {{macros.startbox("System", "col")}}
                <b>Uptime: </b>
                <p id="uptime_counter">LOADING...</p>

                <hr>

                <b>Database Repair: </b>
                <p>
                    There is an emergency database repair tool available.
                    Please consult documentation.
                </p>
            {{macros.endbox()}}
<div style="display:none">
            {{macros.startbox("Box #10", "col")}}
                <pre>
Hello Mama and Dad, I had to call collect
'Cause I ain't got a cent to my name
Well I'm sleepin' in the hotel doorway
And tonight they say it's gonna rain
And if you'd only send me some money
I'll be back on my feet again
Send it in care of the Sunday Mission
Box number ten.
                </pre>
                <b>RIP</b> Jim Croce & Maury Muehleisen
            {{macros.endbox()}}
</div>
        </div>

    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
    <script src="{{ url_for('static', filename='/js/admin.js') }}"></script>

    <script>
        // TODO: Uptime could be incremented without calling back to the server each second to see if a second has really gone by:
        function updateUptimeCounter(){
            $.get("/admin/uptime", function(data) {
                $("#uptime_counter").html(data);
                setTimeout(updateUptimeCounter, 1000);
            });
        }
        updateUptimeCounter();
    </script>
{% endblock %}
